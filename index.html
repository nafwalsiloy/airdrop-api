<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airdrop Claim</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Airdrop Claim</h1>
    <button id="connectButton">Connect Wallet</button>
    <button id="checkEligibilityButton" disabled>Check Eligibility</button>
    <button id="claimButton" disabled>Claim Airdrop</button>
    <p id="status"></p>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        let provider;
        let signer;
        let userAddress;
        let eligibility = false;
        let value;
        let proof;

        const connectButton = document.getElementById('connectButton');
        const checkEligibilityButton = document.getElementById('checkEligibilityButton');
        const claimButton = document.getElementById('claimButton');
        const status = document.getElementById('status');

        // Connect to Ethereum Wallet
        connectButton.addEventListener('click', async () => {
            if (window.ethereum) {
                try {
                    console.log("MetaMask detected.");

                    // Request account access from MetaMask
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

                    if (accounts && accounts.length > 0) {
                        console.log("Wallet connected: ", accounts[0]);

                        // Successfully connected, set the signer and address
                        provider = new ethers.Web3Provider(window.ethereum);
                        signer = provider.getSigner();
                        userAddress = await signer.getAddress();

                        status.textContent = `Wallet connected: ${userAddress}`;

                        // Enable "Check Eligibility" button after successful connection
                        checkEligibilityButton.disabled = false;

                        // Listen for account change
                        window.ethereum.on('accountsChanged', (accounts) => {
                            userAddress = accounts[0];
                            status.textContent = `Wallet changed: ${userAddress}`;
                        });

                        // Listen for network change
                        window.ethereum.on('chainChanged', () => {
                            window.location.reload();
                        });
                    } else {
                        status.textContent = "No accounts found. Please ensure MetaMask is unlocked.";
                    }
                } catch (error) {
                    console.error("Error during wallet connection:", error);
                    
                    if (error.code === 4001) {
                        // User denied the connection
                        status.textContent = "Connection request denied. Please try again.";
                    } else if (error.message.includes("The user rejected the request")) {
                        // Handle user rejection gracefully
                        status.textContent = "User denied the connection. Please try again.";
                    } else {
                        // Generic error handling
                        status.textContent = "Error connecting to wallet.";
                    }
                }
            } else {
                console.log("MetaMask not detected.");
                status.textContent = "Please install MetaMask or another Ethereum wallet.";
            }
        });

        // Check eligibility via API
        checkEligibilityButton.addEventListener('click', async () => {
            status.textContent = "Checking eligibility...";
            try {
                // Replace this with your real API endpoint
                const response = await fetch(`https://airdrop-api.vercel.app/eligibility?address=${userAddress}`);
                const data = await response.json();

                if (data.eligible) {
                    eligibility = true;
                    value = data.value;  // The value to claim
                    proof = data.proof;  // Proof (if needed)
                    claimButton.disabled = false;
                    status.textContent = `You are eligible for an airdrop of ${value} tokens!`;
                } else {
                    eligibility = false;
                    status.textContent = "You are not eligible for the airdrop.";
                }
            } catch (error) {
                status.textContent = "Error checking eligibility.";
                console.error(error);
            }
        });

        // Claim the airdrop
        claimButton.addEventListener('click', async () => {
            if (!eligibility) {
                status.textContent = "You are not eligible for the airdrop.";
                return;
            }

            status.textContent = "Claiming airdrop...";
            try {
                // Replace this with your real contract address and ABI
                const contractAddress = "YOUR_CONTRACT_ADDRESS";
                const contractABI = [
                    "function claim(address recipient, uint256 value, bytes32[] calldata proof) external"
                ];

                const contract = new ethers.Contract(contractAddress, contractABI, signer);
                const tx = await contract.claim(userAddress, value, proof);
                await tx.wait();

                status.textContent = "Airdrop claimed successfully!";
            } catch (error) {
                status.textContent = "Error claiming airdrop.";
                console.error(error);
            }
        });
    </script>
</body>
</html>
